---
title: "A2"
author: "Ruilin Peng"
date: "11/7/2023"
output: pdf_document
---


```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(openintro)
library(tidyverse)
```



## Introduction

<Here you should have a few paragraphs of text introducing the problem, getting the reader interested/ready for the rest of the report.>

<Introduce terminology.>

<Highlight hypotheses.>

<Optional: You can also include a description of each section of this report as a last paragraph.>
As the 45th Canadian Election is approaching, the race between “Liberal” and “Conservative” is kicked off again, and it is curious which party will gain the most trust of most citizens and how much support rates between these two political speakers can be differentiated. The Liberal and the Conservative parties dominate the political system of Canada and the show plays between these parties (Canada Guide, 2023). The Liberal party leans on progressive policies and social transformation, and the Liberal encourages free-market competition in economics, diversity of minorities, and inclusion of immigrants. As opposed to the Liberal, the Conservative prefers traditional and preservative rules,   
imposes more government regulation on economics, and disagrees with social activism. Moreover, if we look at the recent 20 years of popular vote percentages, the Liberal Party almost beats the Conservative Party for each election with an outstanding difference (Simon Fraser University, 2021). Therefore, we hypothesize that the Liberal party is still going to win the election and it is exciting to see if there is any chance that the Conservative will probably present a surprise.

The goal of this study of both survey and census data is to predict which political party of Canada is going to win the most popular votes in the 2025 Canadian Election based on the information of the previous 2021 Canadian Election. This study matches the survey data collected from the 2021 CES (Canadian Election Study) online survey with the census data collected from the Canada GSS (General Social Survey) and predicts the voting decision of respondents in the next 2025 Election in a logistic regression model based on demographic variables of respondents which include age, sex (male/female), language (English/French), income class (Low, Medium and High), the religious or atheist, and the races (the white or the other minorities). (Stephenson et al., 2021). To enhance the representativeness of the population, we apply the stratification method that divides the survey respondents into strata by different variables and conclude the estimated voting probability to infer the possible outcomes in the 2025 Election. 

Importantly, our analysis provides a demonstration of the relationship between the selected variables and the binary outcomes of voting decisions (vote or not vote) to see how the change of variables influences the change of probability change in vote. In this case, the result of the analysis can be an essential reference for future study of Canadian elections, and representatives of parties may set up relevant rules and benefits to increase their political reputation and construct campaign strategies according to the favorable factors considered by respondents. Furthermore, the government may refine relevant policy in terms of the races, employment, income, and other socioeconomic data presented in this study. 



## Data

<Type here a paragraph introducing the data, its context and as much info about the data collection process that you know.>


```{r, include = FALSE}

# Here you can load in and clean the census data (you may need to do the cleaning in a separate R script). 

census_data <- read_csv("gss_clean.csv")

# You may need additional chunks, in case you want to include some of the cleaning output.

```


<Type here a summary of the cleaning process (**only add in stuff beyond my original gss_cleaning.R code**). You only need to describe additional cleaning that you and your group did.> ] You will need to describe the cleaning you do to the survey data as well. 


```{r, include = FALSE}

# Here you can load in and clean the survey data. 
# All cleaning must be done in the same Rmd file as your final report. 
# All cleaning must not be shown in the submitted pdf. 
# Setting the cleaning chunk to include = FALSE will allow for this. 

load('ces2021.RData')

## The data dictionary is found in '2021 Canadian Election Study Codebook.pdf'
## In the data dictionary you can find the survey questions/responses corresponding to the column names in survey_data. 
## For example 

# cps21_age: Respondent age in years. Calculated from cps21_yob.
## cps21_votechoice: "Which party do you think you will vote for? - Selected Choice"

## Furthermore, when you select a variable in the survey_data, you will also see a description of the variable!. 
## If it's a categorical variable, you'll also see how it's coded! 
## For example: 

# suvey_data$cps21_votechoice
# attr(,"label")
# [1] "Which party do you think you will vote for? - Selected Choice"
# attr(,"format.stata")
# [1] "%32.0g"
# attr(,"class")
# [1] "haven_labelled"
# attr(,"labels")
#                    Liberal Party               Conservative Party                              ndp 
#                                1                                2                                3 
#                   Bloc Québécois                      Green Party   Another party (please specify) 
#                                4                                5                                6 
# Don't know/ Prefer not to answer 
#                                7 



```

test

```{r, include = FALSE}

#### You will need to update/clean the code below based off the variables you want to use in your poststratification.

survey_data1 <- 
  survey_data %>% 
  mutate(age = cps21_age,
         vote_liberal = ifelse(cps21_votechoice==1, 1, 0),
         gender = case_when(cps21_genderid == 1 ~ "Male",  # This place should change the name of "gender" to "sex"
                            cps21_genderid == 2 ~ "Female"),
         language = case_when(UserLanguage == "FR-CA" ~ "FR",
                              UserLanguage == "EN" ~ "EN"),
         quebec = ifelse(cps21_province == 11, 1, 0),
<<<<<<< Updated upstream
         religion = ifelse(cps21_religion == 1, 0, 1), # have religion or not
         minority = ifelse(cps21_vismin_9 == 1, 1, 0), # white people or other minorities
        income = case_when(cps21_income_cat < 4 ~ "Low",
=======
         religion = ifelse(cps21_religion == 1, 0, 1),
         minority = ifelse(cps21_vismin_9 == 1, 1, 0),
         income = case_when(cps21_income_cat < 4 ~ "Low",
>>>>>>> Stashed changes
                            cps21_income_cat == 4 ~ "Medium",
                            cps21_income_cat > 4 ~ "High"),
         ) %>% 
  select(age, vote_liberal, gender, language, quebec,religion,minority, income) %>% 
  filter(age >= 18) %>%
  na.omit()    # This might not be the correct thing to do. 

census_data1 <- census_data %>% 
  mutate(age=round(age),
         language = case_when(language_home == "French" ~ "FR",
                              language_home == "English" ~ "EN"),
         quebec = case_when(province == "Quebec" ~ 1,
                              TRUE ~ 0),
         income = case_when(income_respondent == "Less than $25,000" ~ "Low",
                            income_respondent == "$50,000 to $74,999" ~ "Medium", 
                            income_respondent == "$25,000 to $49,999" ~ "Low",
                            
                            TRUE ~ "High"),
         religion = ifelse(religion_has_affiliation == "No religious affiliation",0,1),
         minority = ifelse(vis_minority == "Not a visible minority",0,1))%>% 
  rename(gender = sex, )%>%
  select(age, gender, language, quebec, income, religion, minority)%>%
  filter(age >= 18) %>%
  na.omit() 

```


<Remember, you may want to use multiple datasets here, if you do end up using multiple data sets, or merging the data, be sure to describe this in the cleaning process and be sure to discuss important aspects of all the data that you used.>

<Include a description of the important variables.> 

```{r, include=FALSE}

# Use this to calculate some summary measures. 
summary_table_age <- survey_data1 %>% summarise(
                                  min = min(age),
                                  Q1 = quantile(age,0.25),
                                  median = median(age),
                                  Q3 = quantile(age,0.75),
                                  max = max(age),
                                  IQR = Q3 - Q1,
                                  mean = mean(age), 
                                  sd = sd(age)) 
kable(summary_table_age)



```


<Include a description of the numerical summaries. Remember you can use `r ` to use inline R code.>

```{r, echo = TRUE}

# Use this to create some plots. Should probably describe both the sample and population.
survey_age <- survey_data1 %>% ggplot(aes(x = age)) + geom_histogram(fill = "blue", color = "black", bins = 18) + theme_classic()+
  labs(x = "Age survey", y = "Frequency", title = "Histogram of ...")

census_age <- census_data1 %>% ggplot(aes(x = age)) + geom_histogram(fill = "blue", color = "black", bins = 18) + theme_classic()+
  labs(x = "Age census", y = "Frequency", title = "Histogram of ...")

survey_income <- survey_data1 %>% ggplot(aes(x = income, fill = income)) + 
  geom_bar() + theme_classic() + coord_flip()+
  labs(x = "Income from survey data", y = "Frequency", title = "Histogram of ...")

census_income <- census_data1 %>% ggplot(aes(x = income, fill = income)) + 
  geom_bar() + theme_classic() + coord_flip()+
  labs(x = "Income from census data", y = "Frequency", title = "Histogram of ...")

library(patchwork)
survey_age | census_age
survey_income | census_income

```

<Include a clear description of the plot(s). I would recommend one paragraph for each plot.> 


## Methods

<Include some text introducing the methodology, maybe restating the problem/goal of this analysis.>
Some assumptions are made before constructing our logistic regression model: The voting outcome of respondents is binary, that is, the respondents either vote for the party or not, the selected categorical variables are independent in both the logistic model built for the Liberal and the Conservative. 

### Model Specifics
<Here you can describe your regression model>

<I will (incorrectly) be using a linear regression model to model the proportion of voters who will vote for the liberal party. This is a naive model. I will only be using age, which is recorded as a numeric variable, to model the probability of voting for the liberal party. The simple linear regression model I am using is:> 

$$ log(\frac{p}{1-p}) = \beta_0+\beta_1 x_{age}+\beta_2 x_{gender}+\beta_3 x_{language}+\beta_4 x_{quebec}+\beta5 x_{income}+\beta6 x_{religion}+\beta7 x_{minority}$$

<Where $y$ represents the ....  $\beta_0$ represents....>




```{r, include=TRUE}

# Creating the Model
model <- glm(vote_liberal ~ age + gender + language + quebec + income + religion + minority, data=survey_data1, family = "binomial")

#summary(model)

#predict(model,type = "response")

# Model Results (to Report in Results section)
# summary(model)
# OR
# broom::tidy(model)

### Don't show the results/output here...

```


## Post-Stratification 

<Here you should explain the poststratification process>

<In order to estimate the proportion of voters.....>

<To put math/LaTeX inline just use one set of dollar signs. Example: $\hat{y}^{PS}$ >

<To put math on its own line use two sets of dollar signs:>

$$ include.your.mathematical.model.here.if.you.have.some.math.to.show $$


All analysis for this report was programmed using `R version 4.0.2`. 



## Results 

```{r, include=FALSE}

# Creating the Model
model <- lm(vote_liberal ~ age, data=survey_data)

# Model Results (to Report in Results section)
# summary(model)
# OR
# broom::tidy(model)
```

```{r, include=FALSE}

# Here I will perform the post-stratification calculation
census_data_counts <- census_data %>% 
  group_by(age) %>% 
  summarise(n=n())

census_data_counts$estimate <-
  model %>%
  predict(newdata = census_data_counts)

census_data_counts %>% 
  mutate(liberal_predict_prop = estimate*n) %>%
  summarise(liberal_predict = sum(liberal_predict_prop)/sum(n))

```

<Here you present your results. You may want to put them into a well formatted table. Be sure that there is some text describing the results.>


<Note: Alternatively you can use the `knitr::kable` function to create a well formatted table from your code. See here: [https://rmarkdown.rstudio.com/lesson-7.html](https://rmarkdown.rstudio.com/lesson-7.html).>



<Remember you can use `r ` to use inline R code.>


```{r, include = FALSE}

# Here you can include some relevant visualizations.


```

<Include an explanation/interpretation of the visualizations. Make sure to comment on the appropriateness of the assumptions/results.>

## Conclusions

<Here you should give a summary of the Hypotheses, Methods and Results>

<Highlight Key Results.>

<Talk about big picture.>

<Comment on any Weaknesses.>

<Comment on Future Work/Next Steps>

<End with a concluding paragraph to wrap up the report.>


## Bibliography

1. Grolemund, G. (2014, July 16) *Introduction to R Markdown*. RStudio. [https://rmarkdown.rstudio.com/articles_intro.html](https://rmarkdown.rstudio.com/articles_intro.html). (Last Accessed: April 4, 1991) 

2.  RStudio Team. (2020). *RStudio: Integrated Development for R*. RStudio, PBC, Boston, MA URL [http://www.rstudio.com/](http://www.rstudio.com/).

3.  Allaire, J.J., et. el. *References: Introduction to R Markdown*. RStudio. [https://rmarkdown.rstudio.com/docs/](https://rmarkdown.rstudio.com/docs/). (Last Accessed: April 4, 1991) 

4. OpenAI. (2023). *ChatGPT (September 13 version) [Large language model]*. [https://chat.openai.com/chat](https://chat.openai.com/chat) (Last Accessed: September 13, 2023)

Stephenson, Laura B., Allison Harell, Daniel Rubenson and Peter John Loewen. (2021). *The 2021 Canadian Election Study*. Consortium on Electoral Democracy. [dataset]

Canada Guide. (2023). *Canadian Political Parties*. https://thecanadaguide.com/government/political-parties/ (Last Accessed: November 11, 2023)

Tossutti, L. & Elections Canada. (2007). *La participation électorale des membres des communautés ethnoculturelles*. Élections Canada.

Simon Fraser University. (2021). *Canadian Election Results by Party 1867 to 2021*. https://www.sfu.ca/~aheard/elections/1867-present.html (Last Accessed: November 11, 2023)

\newpage

## Appendix

## Generative AI Statement

Here is where you can explain your usage of Generative AI tool(s). Be sure to reference it. For instance, including something like: 

I used the following generative artificial intelligence (AI) tool: Bing AI Version 2.0 for Chrome [4]. I used the tool only in the Results section of this assignment and I gave it the following prompt of `What should I eat for breakfast?` and it gave me a list of 10 breakfast items which I then asked it to: `Please only list breakfast items that do not include eggs`. I then chose my 3 favourite items from the produced list and included those in the Results section.


### Supplementary Materials

<Here you can include any additional plots, tables, derivations, etc.>
